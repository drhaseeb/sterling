/**
 * STERLING FINANCE - ALL-IN-ONE UK FINANCE APP
 * * ARCHITECTURE NOTES:
 * This file is a single-file representation of a modular React app.
 * Sections are clearly marked for future separation.
 */

import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  LayoutDashboard, Wallet, PieChart, ScanLine, Plus, ArrowUpRight, ArrowDownLeft, 
  TrendingUp, Loader2, Check, X, Landmark, Target, Filter, PiggyBank, Settings, 
  Save, UploadCloud, FileJson, ChevronRight, Calculator
} from 'lucide-react';

// --- FIREBASE IMPORTS ---
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, serverTimestamp, updateDoc } from 'firebase/firestore';

// ==========================================
// MODULE 1: CONFIGURATION & UTILITIES
// ==========================================

// Helper: UK Currency Formatter
const formatGBP = (amount) => {
  return new Intl.NumberFormat('en-GB', {
    style: 'currency',
    currency: 'GBP',
    minimumFractionDigits: 2
  }).format(amount);
};

// Helper: LocalStorage Key Manager (For GitHub Hosting Security)
const STORAGE_KEY_CONFIG = 'sterling_firebase_config';
const STORAGE_KEY_GEMINI = 'sterling_gemini_key';

const getStoredConfig = () => {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG));
  } catch (e) { return null; }
};

// ==========================================
// MODULE 2: AI SERVICE (GEMINI)
// ==========================================

const callGeminiVision = async (base64Image) => {
  // Priority: 1. LocalStorage Key (User provided), 2. Environment Key (Demo)
  let apiKey = localStorage.getItem(STORAGE_KEY_GEMINI);
  if (!apiKey) apiKey = ""; // Fallback to env key if available in context

  if (!apiKey) throw new Error("API Key Missing. Please add it in Settings.");

  const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
  
  const payload = {
    contents: [{
      parts: [
        { text: "Analyze this financial document. Return a strict JSON object with: { \"merchant\": string, \"amount\": number, \"date\": string (YYYY-MM-DD), \"category\": string (suggest: Groceries, Transport, Utilities, Dining, Income, Bills, Health, Savings), \"taxDeductible\": boolean (true if business expense), \"taxAmount\": number (if explicit tax shown) }. Return { \"error\": \"Not a receipt\" } if invalid." },
        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
      ]
    }],
    generationConfig: { responseMimeType: "application/json" }
  };

  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!response.ok) throw new Error(`AI Error: ${response.statusText}`);
  const data = await response.json();
  return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
};

// ==========================================
// MODULE 3: FIREBASE INITIALIZATION
// ==========================================

// Logic: Try to load from LocalStorage (User's repo), otherwise use Env (Demo)
const activeConfig = getStoredConfig() || JSON.parse(__firebase_config || '{}');
const app = initializeApp(activeConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// ==========================================
// MODULE 4: MAIN APPLICATION COMPONENT
// ==========================================

export default function SterlingApp() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);
  
  // Global State for Data
  const [transactions, setTransactions] = useState([]);
  const [investments, setInvestments] = useState([]);
  const [budgets, setBudgets] = useState([]);
  const [goals, setGoals] = useState([]);

  // --- AUTHENTICATION BOOTSTRAP ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) setLoading(false);
    });
  }, []);

  // --- REAL-TIME DATA LISTENERS ---
  useEffect(() => {
    if (!user) return;
    setLoading(true);

    // 1. Transactions
    const unsubTx = onSnapshot(
      query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions')),
      (snap) => setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date)))
    );

    // 2. Investments
    const unsubInv = onSnapshot(
      query(collection(db, 'artifacts', appId, 'users', user.uid, 'investments')),
      (snap) => setInvestments(snap.docs.map(d => ({ id: d.id, ...d.data() })))
    );

    // 3. Budgets
    const unsubBud = onSnapshot(
      query(collection(db, 'artifacts', appId, 'users', user.uid, 'budgets')),
      (snap) => setBudgets(snap.docs.map(d => ({ id: d.id, ...d.data() })))
    );

    // 4. Goals
    const unsubGoals = onSnapshot(
      query(collection(db, 'artifacts', appId, 'users', user.uid, 'goals')),
      (snap) => {
        setGoals(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        setLoading(false);
      }
    );

    return () => { unsubTx(); unsubInv(); unsubBud(); unsubGoals(); };
  }, [user]);

  // --- ROUTING ---
  const renderView = () => {
    if (loading) return <div className="flex h-full justify-center items-center"><Loader2 className="animate-spin text-teal-600" size={40} /></div>;
    
    switch(activeTab) {
      case 'dashboard': return <DashboardModule transactions={transactions} investments={investments} budgets={budgets} />;
      case 'wallet': return <WalletModule transactions={transactions} userId={user.uid} />;
      case 'wealth': return <WealthModule investments={investments} userId={user.uid} />;
      case 'planning': return <PlanningModule budgets={budgets} goals={goals} transactions={transactions} userId={user.uid} />;
      case 'scanner': return <ScannerModule userId={user.uid} onComplete={() => setActiveTab('wallet')} />;
      case 'settings': return <SettingsModule />;
      default: return <DashboardModule transactions={transactions} investments={investments} budgets={budgets} />;
    }
  };

  return (
    <div className="flex h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
      <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
      <main className="flex-1 overflow-hidden flex flex-col relative">
        {/* Mobile Header */}
        <header className="md:hidden h-16 bg-white border-b border-slate-100 flex items-center justify-between px-4 z-20">
          <div className="flex items-center gap-2 font-bold text-teal-700 text-xl"><Landmark size={20} /> Sterling</div>
          <button onClick={() => setActiveTab('settings')}><Settings size={20} className="text-slate-400" /></button>
        </header>
        
        <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-24 md:pb-8 max-w-6xl mx-auto w-full">
          {renderView()}
        </div>

        {/* Mobile Nav */}
        <MobileNav activeTab={activeTab} setActiveTab={setActiveTab} />
      </main>
    </div>
  );
}

// ==========================================
// MODULE 5: UI COMPONENTS (Layout)
// ==========================================

function Sidebar({ activeTab, setActiveTab }) {
  return (
    <nav className="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 p-6 space-y-8 z-30">
      <div className="flex items-center gap-3 text-teal-700 font-bold text-2xl tracking-tight">
        <div className="p-2 bg-teal-100 rounded-xl"><Landmark size={24} /></div>Sterling
      </div>
      <div className="space-y-1">
        <NavButton id="dashboard" icon={LayoutDashboard} label="Overview" active={activeTab} set={setActiveTab} />
        <NavButton id="wallet" icon={Wallet} label="Wallet & Tax" active={activeTab} set={setActiveTab} />
        <NavButton id="wealth" icon={TrendingUp} label="Wealth & Assets" active={activeTab} set={setActiveTab} />
        <NavButton id="planning" icon={PieChart} label="Budgets & Goals" active={activeTab} set={setActiveTab} />
        <NavButton id="scan" icon={ScanLine} label="AI Scanner" active={activeTab} set={setActiveTab} />
      </div>
      <div className="mt-auto">
        <NavButton id="settings" icon={Settings} label="Config" active={activeTab} set={setActiveTab} />
      </div>
    </nav>
  );
}

function MobileNav({ activeTab, setActiveTab }) {
  return (
    <div className="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 p-2 flex justify-around items-center z-30 safe-area-pb">
      <NavIcon id="dashboard" icon={LayoutDashboard} active={activeTab} set={setActiveTab} />
      <NavIcon id="wallet" icon={Wallet} active={activeTab} set={setActiveTab} />
      <button onClick={() => setActiveTab('scan')} className="bg-teal-600 text-white p-4 rounded-full shadow-lg -mt-8 border-4 border-slate-50"><ScanLine size={24} /></button>
      <NavIcon id="wealth" icon={TrendingUp} active={activeTab} set={setActiveTab} />
      <NavIcon id="planning" icon={PieChart} active={activeTab} set={setActiveTab} />
    </div>
  );
}

const NavButton = ({ id, icon: Icon, label, active, set }) => (
  <button onClick={() => set(id === 'scan' ? 'scanner' : id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${active === id || (id === 'scan' && active === 'scanner') ? 'bg-teal-50 text-teal-700 font-bold' : 'text-slate-500 hover:bg-slate-50'}`}>
    <Icon size={20} /> {label}
  </button>
);

const NavIcon = ({ id, icon: Icon, active, set }) => (
  <button onClick={() => set(id)} className={`p-3 rounded-xl ${active === id ? 'text-teal-600 bg-teal-50' : 'text-slate-400'}`}>
    <Icon size={24} />
  </button>
);

// ==========================================
// MODULE 6: DASHBOARD
// ==========================================

function DashboardModule({ transactions, investments, budgets }) {
  // Calculations
  const totalIncome = transactions.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
  const totalExpense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);
  const totalInvested = investments.reduce((s, i) => s + (i.currentValue || 0), 0);
  const netWorth = (totalIncome - totalExpense) + totalInvested;

  // Budget Health
  const currentMonth = new Date().getMonth();
  const monthlySpend = transactions
    .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === currentMonth)
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  const totalBudgetLimit = budgets.reduce((sum, b) => sum + (parseFloat(b.limit) || 0), 0);

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
      <div>
        <h1 className="text-2xl font-bold text-slate-900">Financial Pulse</h1>
        <p className="text-slate-500">Your complete wealth overview.</p>
      </div>

      {/* NET WORTH CARD */}
      <div className="bg-slate-900 text-white p-8 rounded-3xl shadow-xl relative overflow-hidden">
        <div className="absolute top-0 right-0 w-64 h-64 bg-teal-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
        <div className="relative z-10">
          <p className="text-slate-400 font-medium mb-1">Total Net Worth</p>
          <h2 className="text-5xl font-bold tracking-tighter mb-8">{formatGBP(netWorth)}</h2>
          <div className="grid grid-cols-3 gap-4 border-t border-white/10 pt-6">
            <div>
              <p className="text-xs text-slate-400 uppercase font-bold mb-1">Assets</p>
              <p className="text-xl font-semibold text-teal-400">{formatGBP(totalInvested)}</p>
            </div>
            <div>
              <p className="text-xs text-slate-400 uppercase font-bold mb-1">Cash In</p>
              <p className="text-xl font-semibold text-white">{formatGBP(totalIncome)}</p>
            </div>
            <div>
              <p className="text-xs text-slate-400 uppercase font-bold mb-1">Cash Out</p>
              <p className="text-xl font-semibold text-rose-400">{formatGBP(totalExpense)}</p>
            </div>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        {/* BUDGET HEALTH */}
        <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-bold text-slate-800">Monthly Budget</h3>
            <span className="text-xs font-bold bg-slate-100 px-2 py-1 rounded-lg text-slate-600">
              {new Date().toLocaleString('default', { month: 'long' })}
            </span>
          </div>
          <div className="flex items-end gap-2 mb-2">
            <span className="text-2xl font-bold text-slate-900">{formatGBP(monthlySpend)}</span>
            <span className="text-sm text-slate-400 mb-1">/ {formatGBP(totalBudgetLimit)}</span>
          </div>
          <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
            <div 
              className={`h-full rounded-full ${monthlySpend > totalBudgetLimit ? 'bg-rose-500' : 'bg-teal-500'}`} 
              style={{ width: `${totalBudgetLimit > 0 ? Math.min((monthlySpend/totalBudgetLimit)*100, 100) : 0}%` }}
            ></div>
          </div>
        </div>

        {/* RECENT ACTIVITY */}
        <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
          <h3 className="font-bold text-slate-800 mb-4">Recent Transactions</h3>
          <div className="space-y-3">
            {transactions.slice(0, 3).map(tx => (
              <div key={tx.id} className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${tx.type === 'income' ? 'bg-teal-100 text-teal-700' : 'bg-rose-100 text-rose-700'}`}>
                    {tx.type === 'income' ? <ArrowUpRight size={14}/> : <ArrowDownLeft size={14}/>}
                  </div>
                  <div className="text-sm">
                    <p className="font-bold text-slate-900">{tx.merchant || tx.category}</p>
                    <p className="text-xs text-slate-500">{new Date(tx.date).toLocaleDateString()}</p>
                  </div>
                </div>
                <span className={`font-bold text-sm ${tx.type === 'income' ? 'text-teal-600' : 'text-slate-900'}`}>
                  {tx.type === 'income' ? '+' : '-'}{formatGBP(tx.amount)}
                </span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// ==========================================
// MODULE 7: WALLET (Transactions)
// ==========================================

function WalletModule({ transactions, userId }) {
  const [showAdd, setShowAdd] = useState(false);
  const [filterCat, setFilterCat] = useState('All');
  const [filterTime, setFilterTime] = useState('all');

  // Derived Lists
  const categories = ['All', ...new Set(transactions.map(t => t.category))];
  const filtered = transactions.filter(t => {
    const matchCat = filterCat === 'All' || t.category === filterCat;
    const date = new Date(t.date);
    const now = new Date();
    const matchTime = filterTime === 'all' ? true :
                      filterTime === 'month' ? date.getMonth() === now.getMonth() :
                      date.getFullYear() === now.getFullYear();
    return matchCat && matchTime;
  });

  const deleteTx = async (id) => {
    if(confirm('Delete transaction?')) await deleteDoc(doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'transactions', id));
  };

  return (
    <div className="space-y-6 animate-in fade-in">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-slate-900">Wallet</h2>
        <button onClick={() => setShowAdd(true)} className="bg-teal-600 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-teal-700 transition-colors shadow-lg shadow-teal-600/20">
          <Plus size={18} /> Add Entry
        </button>
      </div>

      {/* FILTERS */}
      <div className="bg-white p-3 rounded-xl border border-slate-200 flex gap-3 overflow-x-auto">
        <div className="flex items-center gap-2 px-3 text-slate-400 border-r border-slate-100"><Filter size={16}/><span className="text-xs font-bold uppercase">Filter</span></div>
        <select value={filterCat} onChange={e => setFilterCat(e.target.value)} className="bg-slate-50 rounded-lg px-3 py-1 text-sm font-medium outline-none">
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
        <select value={filterTime} onChange={e => setFilterTime(e.target.value)} className="bg-slate-50 rounded-lg px-3 py-1 text-sm font-medium outline-none">
          <option value="all">All Time</option>
          <option value="month">This Month</option>
          <option value="year">This Year</option>
        </select>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
        {filtered.length === 0 ? <div className="p-12 text-center text-slate-400">No transactions found.</div> : 
        filtered.map(tx => (
          <div key={tx.id} className="flex items-center justify-between p-5 border-b border-slate-50 hover:bg-slate-50 transition-colors group">
             <div className="flex items-center gap-4">
                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${tx.type === 'income' ? 'bg-teal-100 text-teal-600' : 'bg-slate-100 text-slate-500'}`}>
                  {tx.type === 'income' ? <ArrowUpRight size={20}/> : <ArrowDownLeft size={20}/>}
                </div>
                <div>
                  <div className="flex items-center gap-2">
                    <p className="font-bold text-slate-900">{tx.merchant || 'Unknown'}</p>
                    {tx.taxDeductible && <span className="text-[10px] bg-blue-100 text-blue-700 px-1.5 rounded font-bold">TAX DED.</span>}
                  </div>
                  <p className="text-xs text-slate-500">{new Date(tx.date).toLocaleDateString()} • {tx.category}</p>
                </div>
             </div>
             <div className="text-right">
               <p className={`font-bold ${tx.type === 'income' ? 'text-teal-600' : 'text-slate-900'}`}>{tx.type === 'income' ? '+' : '-'}{formatGBP(tx.amount)}</p>
               {tx.taxAmount > 0 && <p className="text-[10px] text-slate-400">Tax: {formatGBP(tx.taxAmount)}</p>}
               <button onClick={() => deleteTx(tx.id)} className="text-[10px] text-rose-500 opacity-0 group-hover:opacity-100">Delete</button>
             </div>
          </div>
        ))}
      </div>

      {showAdd && <AddTransactionModal userId={userId} onClose={() => setShowAdd(false)} />}
    </div>
  );
}

function AddTransactionModal({ userId, onClose }) {
  const [form, setForm] = useState({ type: 'expense', amount: '', merchant: '', category: 'Groceries', date: new Date().toISOString().split('T')[0], taxDeductible: false, taxAmount: '' });

  const handleSubmit = async (e) => {
    e.preventDefault();
    await addDoc(collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'transactions'), {
      ...form, amount: parseFloat(form.amount), taxAmount: parseFloat(form.taxAmount || 0), createdAt: serverTimestamp()
    });
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 animate-in zoom-in-95">
        <div className="flex justify-between mb-4">
          <h3 className="font-bold text-lg">Add Entry</h3>
          <button onClick={onClose}><X className="text-slate-400"/></button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="flex bg-slate-100 p-1 rounded-xl">
            {['expense', 'income'].map(t => (
              <button type="button" key={t} onClick={() => setForm({...form, type: t})} className={`flex-1 py-2 capitalize rounded-lg text-sm font-bold ${form.type === t ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400'}`}>{t}</button>
            ))}
          </div>
          <div className="grid grid-cols-2 gap-3">
             <input type="number" placeholder="Amount" required value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} className="bg-slate-50 p-3 rounded-xl outline-none" />
             <input type="date" required value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="bg-slate-50 p-3 rounded-xl outline-none" />
          </div>
          <input type="text" placeholder={form.type === 'income' ? "Source (e.g. Salary)" : "Merchant (e.g. Tesco)"} required value={form.merchant} onChange={e => setForm({...form, merchant: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl outline-none" />
          
          <select value={form.category} onChange={e => setForm({...form, category: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl outline-none">
            {['Groceries', 'Transport', 'Utilities', 'Dining', 'Shopping', 'Salary', 'Freelance', 'Bills', 'Health', 'Entertainment'].map(c => <option key={c}>{c}</option>)}
          </select>

          {/* Tax Logic */}
          <div className="p-3 border border-slate-100 rounded-xl">
             {form.type === 'expense' ? (
               <label className="flex items-center gap-2 text-sm font-medium text-slate-600">
                 <input type="checkbox" checked={form.taxDeductible} onChange={e => setForm({...form, taxDeductible: e.target.checked})} className="rounded text-teal-600 focus:ring-teal-500"/>
                 Is this Tax Deductible?
               </label>
             ) : (
               <input type="number" placeholder="Tax Withheld (£)" value={form.taxAmount} onChange={e => setForm({...form, taxAmount: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg outline-none text-sm" />
             )}
          </div>

          <button className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Save Transaction</button>
        </form>
      </div>
    </div>
  );
}

// ==========================================
// MODULE 8: WEALTH (Investments)
// ==========================================

function WealthModule({ investments, userId }) {
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({ name: '', type: 'Index Fund', currentValue: '', interestRate: '' });

  const handleAdd = async (e) => {
    e.preventDefault();
    await addDoc(collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'investments'), {
      ...form, currentValue: parseFloat(form.currentValue), interestRate: parseFloat(form.interestRate || 0), updatedAt: serverTimestamp()
    });
    setShowAdd(false);
    setForm({ name: '', type: 'Index Fund', currentValue: '', interestRate: '' });
  };

  const deleteInv = async (id) => await deleteDoc(doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'investments', id));

  const totalWealth = investments.reduce((s, i) => s + (i.currentValue || 0), 0);

  return (
    <div className="space-y-6 animate-in fade-in">
       <div className="bg-indigo-900 text-white p-8 rounded-[2.5rem] shadow-xl relative overflow-hidden">
         <div className="relative z-10">
            <p className="text-indigo-200 mb-1 font-medium">Total Invested Assets</p>
            <h2 className="text-4xl font-bold">{formatGBP(totalWealth)}</h2>
            <div className="mt-6">
               <button onClick={() => setShowAdd(true)} className="bg-white text-indigo-900 px-5 py-2 rounded-xl font-bold text-sm hover:bg-indigo-50 transition-colors">+ Add Asset</button>
            </div>
         </div>
       </div>

       {showAdd && (
         <form onSubmit={handleAdd} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-lg animate-in slide-in-from-top-2">
            <h3 className="font-bold mb-4">New Asset</h3>
            <div className="grid md:grid-cols-2 gap-4 mb-4">
              <input placeholder="Asset Name (e.g. S&P 500)" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="bg-slate-50 p-3 rounded-xl outline-none" />
              <select value={form.type} onChange={e => setForm({...form, type: e.target.value})} className="bg-slate-50 p-3 rounded-xl outline-none">
                {['Index Fund', 'Savings Account', 'Stock', 'Crypto', 'Real Estate', 'Pension', 'ISA'].map(t => <option key={t}>{t}</option>)}
              </select>
              <input type="number" placeholder="Current Value (£)" required value={form.currentValue} onChange={e => setForm({...form, currentValue: e.target.value})} className="bg-slate-50 p-3 rounded-xl outline-none" />
              <input type="number" placeholder="Interest / APY (%)" value={form.interestRate} onChange={e => setForm({...form, interestRate: e.target.value})} className="bg-slate-50 p-3 rounded-xl outline-none" />
            </div>
            <div className="flex gap-3">
               <button type="button" onClick={() => setShowAdd(false)} className="flex-1 py-3 text-slate-500 font-bold">Cancel</button>
               <button type="submit" className="flex-1 bg-indigo-600 text-white rounded-xl font-bold">Save Asset</button>
            </div>
         </form>
       )}

       <div className="grid md:grid-cols-2 gap-4">
          {investments.map(inv => (
             <div key={inv.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center group">
                <div className="flex items-center gap-4">
                   <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center">
                      {inv.type === 'Savings Account' ? <PiggyBank size={24} /> : <TrendingUp size={24} />}
                   </div>
                   <div>
                      <p className="font-bold text-slate-900">{inv.name}</p>
                      <div className="flex gap-2 text-xs text-slate-500">
                         <span>{inv.type}</span>
                         {inv.interestRate > 0 && <span className="bg-green-100 text-green-700 px-1.5 rounded font-bold">+{inv.interestRate}% APY</span>}
                      </div>
                   </div>
                </div>
                <div className="text-right">
                   <p className="font-bold text-lg">{formatGBP(inv.currentValue)}</p>
                   <button onClick={() => deleteInv(inv.id)} className="text-xs text-rose-500 opacity-0 group-hover:opacity-100">Remove</button>
                </div>
             </div>
          ))}
       </div>
    </div>
  );
}

// ==========================================
// MODULE 9: PLANNING (Budgets & Goals)
// ==========================================

function PlanningModule({ budgets, goals, transactions, userId }) {
  const [tab, setTab] = useState('budgets');
  
  return (
    <div className="space-y-6 animate-in fade-in">
       <div className="flex bg-white p-1 rounded-xl border border-slate-100 w-fit">
          <button onClick={() => setTab('budgets')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-colors ${tab === 'budgets' ? 'bg-slate-900 text-white' : 'text-slate-500'}`}>Budgets</button>
          <button onClick={() => setTab('goals')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-colors ${tab === 'goals' ? 'bg-slate-900 text-white' : 'text-slate-500'}`}>Savings Goals</button>
       </div>
       {tab === 'budgets' ? <BudgetSection budgets={budgets} transactions={transactions} userId={userId} /> : <GoalSection goals={goals} userId={userId} />}
    </div>
  );
}

function BudgetSection({ budgets, transactions, userId }) {
  const [form, setForm] = useState({ category: 'Groceries', limit: '' });
  const currentMonth = new Date().getMonth();

  const handleSet = async (e) => {
     e.preventDefault();
     // Check if exists, update or add
     const existing = budgets.find(b => b.category === form.category);
     if (existing) {
       await updateDoc(doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'budgets', existing.id), { limit: parseFloat(form.limit) });
     } else {
       await addDoc(collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'budgets'), { ...form, limit: parseFloat(form.limit) });
     }
     setForm({ category: 'Groceries', limit: '' });
  };

  return (
     <div className="space-y-6">
        <form onSubmit={handleSet} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-end gap-4">
           <div className="flex-1">
             <label className="text-xs font-bold text-slate-400 uppercase">Category</label>
             <select value={form.category} onChange={e => setForm({...form, category: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg outline-none">
                {['Groceries', 'Transport', 'Utilities', 'Dining', 'Shopping', 'Bills', 'Health', 'Entertainment'].map(c => <option key={c}>{c}</option>)}
             </select>
           </div>
           <div className="flex-1">
             <label className="text-xs font-bold text-slate-400 uppercase">Monthly Limit (£)</label>
             <input type="number" value={form.limit} onChange={e => setForm({...form, limit: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg outline-none" />
           </div>
           <button className="bg-teal-600 text-white px-6 py-2 rounded-lg font-bold h-10">Set Budget</button>
        </form>

        <div className="grid md:grid-cols-2 gap-4">
           {budgets.map(b => {
              const spent = transactions
                .filter(t => t.type === 'expense' && t.category === b.category && new Date(t.date).getMonth() === currentMonth)
                .reduce((s, t) => s + t.amount, 0);
              const pct = Math.min((spent / b.limit) * 100, 100);
              const isOver = spent > b.limit;
              
              return (
                 <div key={b.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                    <div className="flex justify-between mb-2">
                       <span className="font-bold text-slate-800">{b.category}</span>
                       <span className={`font-bold text-sm ${isOver ? 'text-rose-500' : 'text-slate-500'}`}>{formatGBP(spent)} / {formatGBP(b.limit)}</span>
                    </div>
                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                       <div className={`h-full rounded-full ${isOver ? 'bg-rose-500' : 'bg-teal-500'}`} style={{ width: `${pct}%` }}></div>
                    </div>
                    <p className="text-xs text-slate-400 mt-2 text-right">{isOver ? 'Over Limit' : `${(100-pct).toFixed(0)}% Left`}</p>
                 </div>
              );
           })}
        </div>
     </div>
  );
}

function GoalSection({ goals, userId }) {
   const [form, setForm] = useState({ name: '', target: '', savedAmount: '' });

   const handleAdd = async (e) => {
     e.preventDefault();
     await addDoc(collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'goals'), {
        ...form, target: parseFloat(form.target), savedAmount: parseFloat(form.savedAmount || 0), createdAt: serverTimestamp()
     });
     setForm({ name: '', target: '', savedAmount: '' });
   };

   const deleteGoal = async (id) => await deleteDoc(doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'goals', id));

   return (
      <div className="space-y-6">
         <form onSubmit={handleAdd} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-wrap items-end gap-4">
            <div className="flex-1 min-w-[200px]"><label className="text-xs font-bold text-slate-400 uppercase">Goal Name</label><input value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg outline-none" /></div>
            <div className="w-32"><label className="text-xs font-bold text-slate-400 uppercase">Target (£)</label><input type="number" value={form.target} onChange={e => setForm({...form, target: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg outline-none" /></div>
            <div className="w-32"><label className="text-xs font-bold text-slate-400 uppercase">Saved (£)</label><input type="number" value={form.savedAmount} onChange={e => setForm({...form, savedAmount: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg outline-none" /></div>
            <button className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold h-10">Add Goal</button>
         </form>

         <div className="grid md:grid-cols-2 gap-4">
            {goals.map(g => {
               const pct = Math.min((g.savedAmount / g.target) * 100, 100);
               return (
                  <div key={g.id} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm relative">
                     <div className="flex justify-between mb-4">
                        <div><h3 className="font-bold text-lg">{g.name}</h3><p className="text-xs text-slate-500">{formatGBP(g.savedAmount)} of {formatGBP(g.target)}</p></div>
                        <button onClick={() => deleteGoal(g.id)} className="text-slate-300 hover:text-rose-500"><X size={18} /></button>
                     </div>
                     <div className="h-4 bg-slate-100 rounded-full overflow-hidden mb-2">
                        <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{ width: `${pct}%` }}></div>
                     </div>
                     <div className="flex justify-between items-center">
                        <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">{pct.toFixed(0)}%</span>
                        <button onClick={async () => {
                           const amt = prompt("Amount to add to savings:");
                           if(amt) await updateDoc(doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'goals', g.id), { savedAmount: g.savedAmount + parseFloat(amt) });
                        }} className="text-xs font-bold text-slate-500 hover:text-indigo-600">+ Add Funds</button>
                     </div>
                  </div>
               )
            })}
         </div>
      </div>
   );
}

// ==========================================
// MODULE 10: SCANNER (Gemini AI)
// ==========================================

function ScannerModule({ userId, onComplete }) {
  const [image, setImage] = useState(null);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const inputRef = useRef(null);

  const handleFile = (e) => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result); // For preview
      };
      reader.readAsDataURL(file);
    }
  };

  const processImage = async () => {
    if(!image) return;
    setLoading(true);
    try {
      const base64 = image.split(',')[1]; // Strip prefix
      const data = await callGeminiVision(base64);
      setResult(data);
    } catch (err) {
      alert("Error analyzing image. " + err.message);
    } finally {
      setLoading(false);
    }
  };

  const saveResult = async () => {
    if(!result) return;
    await addDoc(collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'transactions'), {
      merchant: result.merchant || "Unknown",
      amount: parseFloat(result.amount) || 0,
      date: result.date || new Date().toISOString().split('T')[0],
      category: result.category || 'Uncategorized',
      taxDeductible: result.taxDeductible || false,
      taxAmount: result.taxAmount || 0,
      type: 'expense',
      createdAt: serverTimestamp()
    });
    onComplete();
  };

  return (
    <div className="max-w-xl mx-auto animate-in slide-in-from-bottom-8">
       <h2 className="text-2xl font-bold mb-6">AI Receipt Scanner</h2>
       
       {!result ? (
         <div className="flex flex-col gap-6">
            <div onClick={() => inputRef.current?.click()} className="border-2 border-dashed border-slate-300 rounded-3xl h-80 flex flex-col items-center justify-center bg-slate-50 cursor-pointer relative overflow-hidden hover:bg-slate-100 transition-colors">
               {image ? <img src={image} className="absolute inset-0 w-full h-full object-contain p-4" /> : (
                 <>
                   <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm text-teal-600"><ScanLine size={32} /></div>
                   <p className="text-slate-500 font-medium">Tap to Upload Receipt</p>
                 </>
               )}
            </div>
            <input type="file" ref={inputRef} className="hidden" accept="image/*" onChange={handleFile} />
            <button onClick={processImage} disabled={!image || loading} className="bg-teal-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2 disabled:opacity-50">
               {loading ? <><Loader2 className="animate-spin"/> Processing...</> : "Analyze with AI"}
            </button>
         </div>
       ) : (
         <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-lg space-y-4">
            <div className="flex items-center gap-3 pb-4 border-b border-slate-100">
               <div className="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><Check size={20} /></div>
               <h3 className="font-bold text-slate-900">Scan Complete</h3>
            </div>
            <div className="grid grid-cols-2 gap-4">
               <div><label className="text-xs font-bold text-slate-400">Merchant</label><input value={result.merchant} onChange={e => setResult({...result, merchant: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg" /></div>
               <div><label className="text-xs font-bold text-slate-400">Amount (£)</label><input value={result.amount} onChange={e => setResult({...result, amount: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg" /></div>
               <div><label className="text-xs font-bold text-slate-400">Date</label><input value={result.date} onChange={e => setResult({...result, date: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg" /></div>
               <div><label className="text-xs font-bold text-slate-400">Category</label><input value={result.category} onChange={e => setResult({...result, category: e.target.value})} className="w-full bg-slate-50 p-2 rounded-lg" /></div>
            </div>
            <div className="flex items-center gap-2 bg-slate-50 p-3 rounded-xl">
               <input type="checkbox" checked={result.taxDeductible} onChange={e => setResult({...result, taxDeductible: e.target.checked})} />
               <span className="text-sm font-bold text-slate-700">Tax Deductible Expense</span>
            </div>
            <div className="flex gap-3 pt-2">
               <button onClick={() => { setResult(null); setImage(null); }} className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Retake</button>
               <button onClick={saveResult} className="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg">Confirm</button>
            </div>
         </div>
       )}
    </div>
  );
}

// ==========================================
// MODULE 11: SETTINGS (Github/Keys)
// ==========================================

function SettingsModule() {
  const [geminiKey, setGeminiKey] = useState('');
  const [firebaseConf, setFirebaseConf] = useState('');

  useEffect(() => {
    setGeminiKey(localStorage.getItem(STORAGE_KEY_GEMINI) || '');
    setFirebaseConf(localStorage.getItem(STORAGE_KEY_CONFIG) ? JSON.stringify(JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)), null, 2) : '');
  }, []);

  const handleSave = () => {
    if (geminiKey) localStorage.setItem(STORAGE_KEY_GEMINI, geminiKey);
    if (firebaseConf) {
      try {
        JSON.parse(firebaseConf); // Validate JSON
        localStorage.setItem(STORAGE_KEY_CONFIG, firebaseConf);
      } catch (e) {
        alert("Invalid Firebase JSON");
        return;
      }
    }
    alert("Configuration Saved! Reload the app to use new keys.");
    window.location.reload();
  };

  const handleClear = () => {
    localStorage.removeItem(STORAGE_KEY_GEMINI);
    localStorage.removeItem(STORAGE_KEY_CONFIG);
    alert("Keys cleared.");
    window.location.reload();
  };

  return (
    <div className="max-w-2xl mx-auto space-y-8 animate-in fade-in">
      <div>
        <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-3"><Settings className="text-teal-600"/> Configuration</h2>
        <p className="text-slate-500 mt-1">
           For GitHub hosting: Enter your credentials here. They are saved to your browser's LocalStorage, keeping your GitHub repo clean and secure.
        </p>
      </div>

      <div className="space-y-6">
         <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <label className="flex items-center gap-2 font-bold text-slate-700 mb-2"><UploadCloud size={18}/> Firebase Config (JSON)</label>
            <textarea 
               rows={6}
               placeholder='{ "apiKey": "...", "authDomain": "..." }'
               value={firebaseConf}
               onChange={e => setFirebaseConf(e.target.value)}
               className="w-full bg-slate-50 p-4 rounded-xl border border-slate-200 font-mono text-xs outline-none focus:ring-2 focus:ring-teal-500"
            />
         </div>

         <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <label className="flex items-center gap-2 font-bold text-slate-700 mb-2"><FileJson size={18}/> Gemini API Key</label>
            <input 
               type="password"
               placeholder="AIzSy..."
               value={geminiKey}
               onChange={e => setGeminiKey(e.target.value)}
               className="w-full bg-slate-50 p-4 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-teal-500"
            />
         </div>

         <div className="flex gap-4">
            <button onClick={handleSave} className="flex-1 bg-teal-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-teal-600/20 hover:bg-teal-700 transition-colors flex justify-center items-center gap-2">
              <Save size={18}/> Save to LocalStorage
            </button>
            <button onClick={handleClear} className="px-6 py-3 text-rose-500 font-bold bg-rose-50 rounded-xl hover:bg-rose-100 transition-colors">
              Reset Keys
            </button>
         </div>

         <p className="text-xs text-center text-slate-400">
            Note: If you are previewing this on the web platform, default demo keys are used if these fields are empty.
         </p>
      </div>
    </div>
  );
}
